<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestação+ | Acompanhamento de Gravidez (offline, 1 arquivo)</title>
  <meta name="description" content="App completo de acompanhamento de gravidez, que salva no seu navegador e permite exportar/importar um arquivo de backup. 100% HTML (com CSS e JS embutidos)." />
  <style>
    :root{
      --bg:#0b0f14; --panel:#10161d; --muted:#8aa0b3; --text:#e9f0f7; --brand:#7c9cff; --brand-2:#9ef0c9; --danger:#ff6b6b; --warn:#ffd166; --ok:#3ad29f; --line:#1c2733;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f14, #0b0f14 60%, #0e141b), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><defs><pattern id="p" width="48" height="48" patternUnits="userSpaceOnUse" patternTransform="scale(1)"><path d="M0 48 L48 0" stroke="%231c2733" stroke-width="1" opacity="0.3"/></pattern></defs><rect width="100%" height="100%" fill="url(%23p)"/></svg>') fixed; color:var(--text); font:500 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    a{color:var(--brand);text-decoration:none}
    header{position:sticky;top:0;z-index:5;background:rgba(11,15,20,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:38px;height:38px;border-radius:12px;background:conic-gradient(from 200deg at 70% 30%, var(--brand), var(--brand-2)); box-shadow:0 0 0 2px rgba(124,156,255,.15)}
    .brand h1{font-size:18px;margin:0}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button, input, select, textarea{font:inherit;color:inherit}
    button{background:#111925;border:1px solid var(--line);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{border-color:#2a394b}
    button.primary{background:linear-gradient(180deg, #2a3bff22,#2a3bff11); border-color:#3e4dff44}
    button.ghost{background:transparent;border-color:transparent}
    .danger{color:#ffb4b4}
    .ok{color:var(--brand-2)}

    main{padding:18px}
    .grid{display:grid;gap:18px}
    @media(min-width:900px){
      .grid{grid-template-columns: 280px 1fr}
    }

    .card{background:linear-gradient(180deg,#0e141b,#0c1218);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 10px 0;font-size:16px;color:#cfe0f4}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field input,.field select,.field textarea{background:#0f1620;border:1px solid #1b2633;padding:10px 12px;border-radius:12px}
    .field small{color:#91a3b8}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab-btn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0f1722;cursor:pointer}
    .tab-btn.active{border-color:#39506b;background:#111b28}

    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:700px){.kpi{grid-template-columns:repeat(4,1fr)}}
    .kpi .box{padding:12px;border:1px dashed #284055;border-radius:14px;background:#0e1823}
    .kpi .val{font-size:22px}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #12202c;padding:10px 8px;text-align:left}
    tr:hover td{background:#0f1520}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #27405a;background:#0e1825;border-radius:999px;font-size:12px}
    .progress{height:8px;background:#101a26;border:1px solid #203247;border-radius:999px;overflow:hidden}
    .progress > span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-2));width:0%}

    .photo{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .photo figure{border:1px solid var(--line);border-radius:14px;overflow:hidden;margin:0;background:#0f1620}
    .photo img{width:100%;display:block}
    .photo figcaption{padding:8px;color:#b8c7d8}

    .footer{opacity:.7;text-align:center;padding:20px 0}
    .tip{font-size:12px;color:#9eb2c7}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="brand grow">
        <div class="logo" aria-hidden="true"></div>
        <h1>Gestação+ <span class="muted">· offline e privado</span></h1>
      </div>
      <div class="toolbar">
        <button id="btn-export" class="primary" title="Exportar backup (.json)">💾 Exportar</button>
        <label class="chip" title="Importar backup (.json)">📥 Importar
          <input id="file-import" type="file" accept="application/json" style="display:none" />
        </label>
        <button id="btn-reset" class="danger" title="Apagar tudo deste perfil">🗑️ Reset</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- Lateral: perfis e setup -->
    <aside class="card" aria-label="Configurações e Perfis">
      <h3>👤 Perfis</h3>
      <div class="field">
        <label for="perfilSelect">Selecionar perfil</label>
        <select id="perfilSelect"></select>
      </div>
      <div class="row">
        <button id="novoPerfil">➕ Novo</button>
        <button id="renomearPerfil">✏️ Renomear</button>
        <button id="removerPerfil" class="danger">➖ Remover</button>
      </div>
      <div class="hr"></div>

      <h3>⚙️ Dados do casal</h3>
      <div class="field">
        <label>Nome da gestante</label>
        <input id="mae" placeholder="Nome"/>
      </div>
      <div class="field">
        <label>Nome do parceiro(a)</label>
        <input id="parceiro" placeholder="Nome"/>
      </div>
      <div class="field">
        <label>Contato do médico(a)</label>
        <input id="medico" placeholder="Dr(a)., telefone"/>
      </div>

      <div class="hr"></div>
      <h3>🗓️ Início da gestação</h3>
      <div class="field"><label>
        <input type="radio" name="baseData" value="dpp" checked> Tenho a DPP (data provável do parto)
      </label></div>
      <div class="field"><label>
        <input type="radio" name="baseData" value="dum"> Tenho a DUM (data da última menstruação)
      </label></div>

      <div class="field" id="boxDPP">
        <label>📅 DPP</label>
        <input id="dpp" type="date" />
        <small>Se você sabe a DPP, o app calcula o restante.</small>
      </div>
      <div class="field" id="boxDUM" style="display:none">
        <label>📅 DUM</label>
        <input id="dum" type="date" />
        <small>Se você tem a DUM, a DPP será estimada (DUM + 280 dias).</small>
      </div>

      <div class="hr"></div>
      <div class="tip">Privacidade: tudo fica somente no seu navegador. Você também pode <b>exportar</b> um backup e <b>importar</b> depois para continuar.</div>
    </aside>

    <!-- Conteúdo principal -->
    <section>
      <div class="card">
        <div class="kpi">
          <div class="box">
            <div class="muted">Semana</div>
            <div class="val" id="kpiSemana">–</div>
          </div>
          <div class="box">
            <div class="muted">Dias de gestação</div>
            <div class="val" id="kpiDias">–</div>
          </div>
          <div class="box">
            <div class="muted">Falta</div>
            <div class="val" id="kpiFalta">–</div>
          </div>
          <div class="box">
            <div class="muted">DPP</div>
            <div class="val" id="kpiDPP">–</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="progress"><span id="barra"></span></div>
        <div class="tip" id="textoTrimestre" style="margin-top:8px">—</div>
      </div>

      <div class="card">
        <div class="tabs" role="tablist">
          <button class="tab-btn active" data-tab="anotacoes">📝 Anotações</button>
          <button class="tab-btn" data-tab="consultas">📅 Consultas</button>
          <button class="tab-btn" data-tab="sintomas">💬 Sintomas</button>
          <button class="tab-btn" data-tab="medidas">⚖️ Medidas</button>
          <button class="tab-btn" data-tab="ultra">🖼️ Ultrassons</button>
          <button class="tab-btn" data-tab="tarefas">✅ Tarefas</button>
          <button class="tab-btn" data-tab="vacinas">💉 Vacinas</button>
          <button class="tab-btn" data-tab="resumo">📦 Backup & Resumo</button>
        </div>

        <!-- TAB: Anotações -->
        <div class="tab" id="tab-anotacoes">
          <div class="field"><label>Título</label><input id="noteTitulo" placeholder="Ex.: Primeiros chutes"/></div>
          <div class="field"><label>Texto</label><textarea id="noteTexto" rows="5" placeholder="Escreva aqui o que aconteceu hoje..."></textarea></div>
          <div class="row"><button id="addNota" class="primary">Adicionar anotação</button></div>
          <div class="hr"></div>
          <div id="listaNotas"></div>
        </div>

        <!-- TAB: Consultas -->
        <div class="tab" id="tab-consultas" style="display:none">
          <div class="row">
            <div class="field grow"><label>Data</label><input id="cData" type="date"></div>
            <div class="field grow"><label>Hora</label><input id="cHora" type="time"></div>
          </div>
          <div class="field"><label>Local / Profissional</label><input id="cLocal" placeholder="Clínica, endereço"></div>
          <div class="field"><label>Observações</label><input id="cObs" placeholder="Trazer exames, jejum..."></div>
          <button id="addConsulta" class="primary">Adicionar consulta</button>
          <div class="hr"></div>
          <table id="tConsultas"><thead><tr><th>Quando</th><th>Local</th><th>Obs</th><th></th></tr></thead><tbody></tbody></table>
        </div>

        <!-- TAB: Sintomas -->
        <div class="tab" id="tab-sintomas" style="display:none">
          <div class="row">
            <div class="field grow"><label>Data</label><input id="sData" type="date"></div>
            <div class="field grow"><label>Intensidade</label>
              <select id="sInt"><option>Leve</option><option>Médio</option><option>Forte</option></select>
            </div>
          </div>
          <div class="field"><label>Descrição</label><input id="sDesc" placeholder="Ex.: enjoo pela manhã"></div>
          <button id="addSintoma" class="primary">Adicionar</button>
          <div class="hr"></div>
          <table id="tSintomas"><thead><tr><th>Data</th><th>Intensidade</th><th>Descrição</th><th></th></tr></thead><tbody></tbody></table>
        </div>

        <!-- TAB: Medidas -->
        <div class="tab" id="tab-medidas" style="display:none">
          <div class="row">
            <div class="field grow"><label>Data</label><input id="mData" type="date"></div>
            <div class="field grow"><label>Peso (kg)</label><input id="mPeso" type="number" step="0.01" placeholder="Ex.: 62.5"></div>
            <div class="field grow"><label>Barriga (cm)</label><input id="mBarriga" type="number" step="0.1" placeholder="Opcional"></div>
          </div>
          <button id="addMedida" class="primary">Adicionar</button>
          <div class="hr"></div>
          <table id="tMedidas"><thead><tr><th>Data</th><th>Peso</th><th>Barriga</th><th></th></tr></thead><tbody></tbody></table>
        </div>

        <!-- TAB: Ultrasons -->
        <div class="tab" id="tab-ultra" style="display:none">
          <div class="row">
            <div class="field grow"><label>Data</label><input id="uData" type="date"></div>
            <div class="field grow"><label>Observações</label><input id="uObs" placeholder="Ex.: 12 semanas, TN ok"></div>
          </div>
          <div class="field"><label>Foto do exame (opcional)</label><input id="uFoto" type="file" accept="image/*"></div>
          <button id="addUltra" class="primary">Adicionar ultrassom</button>
          <div class="hr"></div>
          <div class="photo" id="galeria"></div>
        </div>

        <!-- TAB: Tarefas -->
        <div class="tab" id="tab-tarefas" style="display:none">
          <div class="row">
            <div class="field grow"><label>Nova tarefa</label><input id="tNova" placeholder="Ex.: Comprar cadeirinha"></div>
            <button id="addTarefa" class="primary">Adicionar</button>
          </div>
          <div id="listaTarefas"></div>
        </div>

        <!-- TAB: Vacinas -->
        <div class="tab" id="tab-vacinas" style="display:none">
          <div class="row">
            <div class="field grow"><label>Vacina</label><input id="vNome" placeholder="Ex.: dTpa, Influenza"></div>
            <div class="field grow"><label>Data</label><input id="vData" type="date"></div>
          </div>
          <button id="addVacina" class="primary">Adicionar</button>
          <div class="hr"></div>
          <table id="tVacinas"><thead><tr><th>Vacina</th><th>Data</th><th></th></tr></thead><tbody></tbody></table>
        </div>

        <!-- TAB: Resumo -->
        <div class="tab" id="tab-resumo" style="display:none">
          <div class="row">
            <button id="btnBaixarTXT">Baixar diário (.txt)</button>
            <button id="btnBaixarCSV">Medidas (.csv)</button>
          </div>
          <p class="tip">Dica: você pode imprimir esta página (Ctrl/Cmd+P) para gerar um PDF do momento atual. 😉</p>
          <pre id="previewResumo" style="white-space:pre-wrap;background:#0f1722;border:1px solid #1b2a3a;border-radius:12px;padding:12px;max-height:300px;overflow:auto"></pre>
        </div>
      </div>

      <div class="footer muted">Feito com ❤️. Tudo que você criar fica salvo somente no seu navegador (LocalStorage). Exporte para garantir um backup.</div>
    </section>
  </main>

  <script>
  // ===== Utilidades =====
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmt = (d) => new Date(d).toLocaleDateString('pt-BR',{timeZone:'UTC'});
  const todayISO = () => new Date().toISOString().slice(0,10);
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

  // ===== Persistência (multi-perfis) =====
  const LS_KEY = 'gestacao_plus_v1';
  const defaultProfile = () => ({
    id: crypto.randomUUID(),
    nome: 'Meu perfil',
    mae:'', parceiro:'', medico:'',
    base:'dpp', dpp:'', dum:'',
    notas:[], consultas:[], sintomas:[], medidas:[], ultras:[], tarefas:[], vacinas:[],
    createdAt: Date.now()
  });

  function loadAll(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {ativos:[], ativoId:null}; }
    catch(e){ return {ativos:[], ativoId:null}; }
  }
  function saveAll(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  let state = loadAll();
  if(!state.ativos.length){
    const p = defaultProfile(); state.ativos.push(p); state.ativoId = p.id; saveAll(state);
  }

  function getAtivo(){ return state.ativos.find(p=>p.id===state.ativoId); }
  function setAtivo(id){ state.ativoId=id; saveAll(state); renderEverything(); }
  function up(cb){ const p=getAtivo(); cb(p); saveAll(state); renderEverything(); }

  // ===== UI: perfis =====
  function renderPerfis(){
    const sel = $('#perfilSelect'); sel.innerHTML='';
    state.ativos.sort((a,b)=>a.createdAt-b.createdAt).forEach(p=>{
      const o = document.createElement('option'); o.value=p.id; o.textContent=p.nome; if(p.id===state.ativoId) o.selected=true; sel.appendChild(o);
    });
  }

  $('#perfilSelect').addEventListener('change', e=> setAtivo(e.target.value));
  $('#novoPerfil').addEventListener('click', ()=>{
    const nome = prompt('Nome do novo perfil?', 'Perfil ' + (state.ativos.length+1)); if(!nome) return;
    const p = defaultProfile(); p.nome = nome; state.ativos.push(p); state.ativoId=p.id; saveAll(state); renderEverything();
  });
  $('#renomearPerfil').addEventListener('click', ()=>{
    const p=getAtivo(); const nome = prompt('Novo nome do perfil:', p.nome); if(!nome) return; p.nome=nome; saveAll(state); renderPerfis();
  });
  $('#removerPerfil').addEventListener('click', ()=>{
    if(!confirm('Remover este perfil e todos os dados dele?')) return;
    state.ativos = state.ativos.filter(p=>p.id!==state.ativoId);
    if(!state.ativos.length){ const p=defaultProfile(); state.ativos=[p]; state.ativoId=p.id; }
    else { state.ativoId = state.ativos[0].id; }
    saveAll(state); renderEverything();
  });

  // ===== Setup (DPP/DUM) =====
  $$('input[name="baseData"]').forEach(r=> r.addEventListener('change', e=>{
    const v=e.target.value; up(p=>{p.base=v});
    $('#boxDPP').style.display = v==='dpp'? 'block':'none';
    $('#boxDUM').style.display = v==='dum'? 'block':'none';
  }));
  $('#dpp').addEventListener('change', e=> up(p=>{p.dpp=e.target.value}));
  $('#dum').addEventListener('change', e=> up(p=>{p.dum=e.target.value}));
  $('#mae').addEventListener('input', e=> up(p=>{p.mae=e.target.value}));
  $('#parceiro').addEventListener('input', e=> up(p=>{p.parceiro=e.target.value}));
  $('#medico').addEventListener('input', e=> up(p=>{p.medico=e.target.value}));

  // ===== Cálculos de gestação =====
  function calcInfo(p){
    let dpp = p.dpp;
    if(p.base==='dum' && p.dum){ // DUM + 280 dias
      const t = new Date(p.dum+'T00:00:00Z'); t.setUTCDate(t.getUTCDate()+280); dpp = t.toISOString().slice(0,10);
    }
    if(!dpp) return {dpp:null, dias:0, semana:"–", falta:"–", perc:0, trimestre:""};

    const tHoje = new Date();
    const dtDPP = new Date(dpp+'T00:00:00');
    const gestLen = 280; // dias aproximados
    const dtConcepcao = new Date(dtDPP); dtConcepcao.setDate(dtConcepcao.getDate()-gestLen);

    const dias = Math.floor((tHoje - dtConcepcao)/(1000*60*60*24));
    const semana = Math.floor(dias/7);
    const falta = Math.max(0, gestLen - dias);
    const perc = clamp((dias/gestLen)*100, 0, 100);
    let trimestre = '';
    if(semana<=12) trimestre = '1º trimestre'; else if(semana<=27) trimestre='2º trimestre'; else trimestre='3º trimestre';

    return {dpp, dias: clamp(dias,0,gestLen), semana: semana+"ª", falta, perc, trimestre};
  }

  // ===== Render KPIs =====
  function renderKPI(){
    const p=getAtivo(); const info=calcInfo(p);
    $('#kpiSemana').textContent = info.semana;
    $('#kpiDias').textContent = Number.isFinite(info.dias)? info.dias : '–';
    $('#kpiFalta').textContent = Number.isFinite(info.falta)? info.falta+ 'd' : '–';
    $('#kpiDPP').textContent = info.dpp? fmt(info.dpp): '–';
    $('#barra').style.width = info.perc+'%';
    $('#textoTrimestre').textContent = info.trimestre? `Você está no ${info.trimestre}. Progresso aproximado de ${info.perc.toFixed(1)}%.` : 'Informe DPP ou DUM para iniciar.';
  }

  // ===== Tabs =====
  $$('.tab-btn').forEach(btn=> btn.addEventListener('click', ()=>{
    $$('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const id = 'tab-'+btn.dataset.tab; $$('.tab').forEach(t=> t.style.display = (t.id===id?'block':'none'));
    if(id==='tab-resumo') renderResumo();
  }));

  // ===== Anotações =====
  $('#addNota').addEventListener('click', ()=>{
    const t = $('#noteTitulo').value.trim(); const x = $('#noteTexto').value.trim();
    if(!t && !x) return; up(p=>{ p.notas.unshift({id:crypto.randomUUID(), titulo:t, texto:x, data: todayISO()}) });
    $('#noteTitulo').value=''; $('#noteTexto').value='';
  });
  function renderNotas(){
    const box = $('#listaNotas'); box.innerHTML=''; const p=getAtivo();
    if(!p.notas.length){ box.innerHTML = '<div class="muted">Sem anotações ainda.</div>'; return; }
    p.notas.forEach(n=>{
      const div = document.createElement('div');
      div.className='card';
      div.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center">
        <div><b>${n.titulo||'Sem título'}</b><div class="tip">${fmt(n.data)}</div></div>
        <button data-id="${n.id}" class="ghost danger">Apagar</button>
      </div>
      <div style="margin-top:8px">${(n.texto||'').replace(/</g,'&lt;')}</div>`;
      div.querySelector('button').addEventListener('click',()=> up(p=>{p.notas=p.notas.filter(i=>i.id!==n.id)}));
      box.appendChild(div);
    });
  }

  // ===== Consultas =====
  $('#addConsulta').addEventListener('click', ()=>{
    const item={id:crypto.randomUUID(), data:$('#cData').value, hora:$('#cHora').value, local:$('#cLocal').value.trim(), obs:$('#cObs').value.trim()};
    if(!item.data) return alert('Informe a data.');
    up(p=>{ p.consultas.push(item); });
    ['#cData','#cHora','#cLocal','#cObs'].forEach(s=>$(s).value='');
  });
  function renderConsultas(){
    const tb = $('#tConsultas tbody'); tb.innerHTML=''; const p=getAtivo();
    p.consultas.sort((a,b)=>(a.data+a.hora).localeCompare(b.data+b.hora)).forEach(c=>{
      const tr = document.createElement('tr');
      tr.innerHTML=`<td>${fmt(c.data)} ${c.hora||''}</td><td>${(c.local||'')}</td><td>${(c.obs||'')}</td><td><button class="ghost danger" data-id="${c.id}">Apagar</button></td>`;
      tr.querySelector('button').addEventListener('click',()=> up(p=>{p.consultas=p.consultas.filter(i=>i.id!==c.id)}));
      tb.appendChild(tr);
    });
  }

  // ===== Sintomas =====
  $('#addSintoma').addEventListener('click', ()=>{
    const item={id:crypto.randomUUID(), data:$('#sData').value||todayISO(), intensidade:$('#sInt').value, desc:$('#sDesc').value.trim()};
    if(!item.desc) return; up(p=>{p.sintomas.unshift(item)});
    $('#sDesc').value='';
  });
  function renderSintomas(){
    const tb = $('#tSintomas tbody'); tb.innerHTML=''; const p=getAtivo();
    p.sintomas.forEach(s=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmt(s.data)}</td><td>${s.intensidade}</td><td>${s.desc}</td><td><button class="ghost danger">Apagar</button></td>`;
      tr.querySelector('button').addEventListener('click',()=> up(p=>{p.sintomas=p.sintomas.filter(i=>i.id!==s.id)}));
      tb.appendChild(tr);
    });
  }

  // ===== Medidas =====
  $('#addMedida').addEventListener('click', ()=>{
    const item={id:crypto.randomUUID(), data:$('#mData').value||todayISO(), peso:parseFloat($('#mPeso').value||''), barriga:$('#mBarriga').value? parseFloat($('#mBarriga').value): null};
    if(!item.peso){ return alert('Informe o peso.'); }
    up(p=>{p.medidas.push(item)});
    ['#mData','#mPeso','#mBarriga'].forEach(s=>$(s).value='');
  });
  function renderMedidas(){
    const tb = $('#tMedidas tbody'); tb.innerHTML=''; const p=getAtivo();
    p.medidas.sort((a,b)=> (a.data).localeCompare(b.data)).forEach(m=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmt(m.data)}</td><td>${m.peso.toFixed(2)} kg</td><td>${m.barriga? m.barriga.toFixed(1)+' cm' : '—'}</td><td><button class="ghost danger">Apagar</button></td>`;
      tr.querySelector('button').addEventListener('click',()=> up(p=>{p.medidas=p.medidas.filter(i=>i.id!==m.id)}));
      tb.appendChild(tr);
    });
  }

  // ===== Ultras =====
  $('#addUltra').addEventListener('click', async ()=>{
    const data = $('#uData').value||todayISO(); const obs=$('#uObs').value.trim(); const f=$('#uFoto').files[0];
    let fotoData=null;
    if(f){ fotoData = await fileToDataURL(f); }
    up(p=>{p.ultras.unshift({id:crypto.randomUUID(), data, obs, foto: fotoData})});
    $('#uObs').value=''; $('#uFoto').value='';
  });
  function fileToDataURL(file){
    return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); });
  }
  function renderUltras(){
    const g=$('#galeria'); g.innerHTML=''; const p=getAtivo();
    if(!p.ultras.length){ g.innerHTML='<div class="muted">Sem ultrassons ainda.</div>'; return; }
    p.ultras.forEach(u=>{
      const fig=document.createElement('figure');
      fig.innerHTML=`${u.foto? `<img src="${u.foto}" alt="Ultrassom ${fmt(u.data)}">` : ''}<figcaption><b>${fmt(u.data)}</b><br>${u.obs||''}<div style="margin-top:6px"><button class="ghost danger">Apagar</button></div></figcaption>`;
      fig.querySelector('button').addEventListener('click',()=> up(p=>{p.ultras=p.ultras.filter(i=>i.id!==u.id)}));
      g.appendChild(fig);
    });
  }

  // ===== Tarefas =====
  $('#addTarefa').addEventListener('click', ()=>{
    const t=$('#tNova').value.trim(); if(!t) return; up(p=>{p.tarefas.unshift({id:crypto.randomUUID(), txt:t, done:false})}); $('#tNova').value='';
  });
  function renderTarefas(){
    const box=$('#listaTarefas'); box.innerHTML=''; const p=getAtivo();
    if(!p.tarefas.length){ box.innerHTML='<div class="muted">Nenhuma tarefa. Que tal criar uma lista de enxoval? 🧺</div>'; return; }
    p.tarefas.forEach(t=>{
      const line=document.createElement('div'); line.className='row'; line.style.alignItems='center'; line.style.justifyContent='space-between';
      const left=document.createElement('label'); left.className='chip';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=t.done; cb.addEventListener('change',()=> up(p=>{const it=p.tarefas.find(i=>i.id===t.id); if(it) it.done=cb.checked;}));
      left.appendChild(cb); left.append(' '+t.txt);
      const del=document.createElement('button'); del.className='ghost danger'; del.textContent='Apagar'; del.addEventListener('click',()=> up(p=>{p.tarefas=p.tarefas.filter(i=>i.id!==t.id)}));
      line.append(left, del); box.appendChild(line);
    });
  }

  // ===== Vacinas =====
  $('#addVacina').addEventListener('click', ()=>{
    const nome=$('#vNome').value.trim(); const data=$('#vData').value; if(!nome || !data) return;
    up(p=>{p.vacinas.push({id:crypto.randomUUID(), nome, data})}); $('#vNome').value=''; $('#vData').value='';
  });
  function renderVacinas(){
    const tb=$('#tVacinas tbody'); tb.innerHTML=''; const p=getAtivo();
    p.vacinas.sort((a,b)=>a.data.localeCompare(b.data)).forEach(v=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${v.nome}</td><td>${fmt(v.data)}</td><td><button class="ghost danger">Apagar</button></td>`;
      tr.querySelector('button').addEventListener('click',()=> up(p=>{p.vacinas=p.vacinas.filter(i=>i.id!==v.id)}));
      tb.appendChild(tr);
    });
  }

  // ===== Exportar / Importar =====
  $('#btn-export').addEventListener('click', ()=>{
    const nome = (getAtivo().nome||'perfil') + '-' + new Date().toISOString().slice(0,10) + '.gestacao.json';
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=nome; a.click(); URL.revokeObjectURL(a.href);
  });
  $('#file-import').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return; const txt=await f.text();
    try{ const data=JSON.parse(txt); if(!data.ativos) throw new Error('formato'); state=data; saveAll(state); renderEverything(); alert('Backup importado com sucesso!'); }
    catch(err){ alert('Arquivo inválido.'); }
    e.target.value='';
  });
  $('#btn-reset').addEventListener('click', ()=>{
    if(!confirm('Tem certeza? Isso apagará todos os dados deste perfil.')) return;
    up(p=>{ p.notas=[]; p.consultas=[]; p.sintomas=[]; p.medidas=[]; p.ultras=[]; p.tarefas=[]; p.vacinas=[]; p.dpp=''; p.dum=''; });
  });

  // ===== Resumo / Downloads rápidos =====
  function gerarDiarioTXT(){
    const p=getAtivo(); const info=calcInfo(p);
    let out = [];
    out.push(`# Gestação+ — Diário de ${p.nome}`);
    out.push(`Gestante: ${p.mae||'-'} | Parceiro(a): ${p.parceiro||'-'} | Médico(a): ${p.medico||'-'}`);
    out.push(`Base: ${p.base==='dpp'? 'DPP' : 'DUM'} | DPP: ${info.dpp? fmt(info.dpp):'-'} | Semana: ${info.semana} | Progresso: ${info.perc.toFixed(1)}%`);
    out.push('\n== Anotações =='); p.notas.forEach(n=> out.push(`- [${fmt(n.data)}] ${n.titulo||'Sem título'} — ${n.texto}`));
    out.push('\n== Consultas =='); p.consultas.forEach(c=> out.push(`- ${fmt(c.data)} ${c.hora||''} @ ${c.local||''} — ${c.obs||''}`));
    out.push('\n== Sintomas =='); p.sintomas.forEach(s=> out.push(`- ${fmt(s.data)} | ${s.intensidade}: ${s.desc}`));
    out.push('\n== Medidas =='); p.medidas.forEach(m=> out.push(`- ${fmt(m.data)} | ${m.peso.toFixed(2)} kg${m.barriga? ' | '+m.barriga.toFixed(1)+' cm':''}`));
    out.push('\n== Vacinas =='); p.vacinas.forEach(v=> out.push(`- ${fmt(v.data)} | ${v.nome}`));
    out.push('\n== Tarefas =='); p.tarefas.forEach(t=> out.push(`- [${t.done?'x':' '}] ${t.txt}`));
    return out.join('\n');
  }
  function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }

  $('#btnBaixarTXT').addEventListener('click', ()=>{
    download((getAtivo().nome||'perfil')+'-diario.txt', gerarDiarioTXT());
  });

  $('#btnBaixarCSV').addEventListener('click', ()=>{
    const p=getAtivo();
    let csv = 'data,peso,barriga\n'; p.medidas.forEach(m=> csv += `${m.data},${m.peso},${m.barriga??''}\n`);
    download((p.nome||'perfil')+'-medidas.csv', csv);
  });

  function renderResumo(){ $('#previewResumo').textContent = gerarDiarioTXT(); }

  // ===== Render geral =====
  function renderEverything(){
    renderPerfis();
    const p=getAtivo();
    // preencher inputs
    $('#mae').value=p.mae||''; $('#parceiro').value=p.parceiro||''; $('#medico').value=p.medico||'';
    $$('input[name="baseData"]').forEach(r=> r.checked = (r.value===p.base));
    $('#boxDPP').style.display = p.base==='dpp'? 'block':'none';
    $('#boxDUM').style.display = p.base==='dum'? 'block':'none';
    $('#dpp').value=p.dpp||''; $('#dum').value=p.dum||'';

    renderKPI();
    renderNotas();
    renderConsultas();
    renderSintomas();
    renderMedidas();
    renderUltras();
    renderTarefas();
    renderVacinas();
  }

  // Init
  renderEverything();
  </script>
</body>
</html>
